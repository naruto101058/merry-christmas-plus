<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Tree v17.6.5 - UI Hints</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&family=Monoton&family=Abril+Fatface&family=Ma+Shan+Zheng&display=swap');
        /* ================= 1. Âü∫Á°ÄËÆæÁΩÆ ================= */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Microsoft YaHei', 'Songti SC', serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* ================= 2. UI ËßÜËßâ (V17.6.3 ÂéüÁâàÊ†∑Âºè) ================= */
        :root {
            --glass-bg: rgba(20, 20, 25, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --accent-gold: #d4af37;
            --accent-gold-gradient: linear-gradient(135deg, #fceea7 0%, #d4af37 100%);
            --text-main: #ffffff;
            --text-sub: #b0b0b5;
            --panel-width: 210px;
            --ui-scale: 0.9;
        }

        @media screen and (max-height: 800px) {
            :root {
                --ui-scale: 0.8;
            }
        }

        @media screen and (min-width: 2000px) {
            :root {
                --ui-scale: 1.1;
            }
        }

        :fullscreen {
            --ui-scale: 1.0;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), inset 0.5px 0.5px 0px var(--glass-highlight), inset -0.5px -0.5px 0px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            overflow: hidden;
            box-sizing: border-box;
        }

        #left-sidebar,
        .bottom-left-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .panel-hidden {
            transform: translateX(calc(-1 * var(--panel-width) - 50px)) scale(var(--ui-scale)) !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .hidden {
            display: none !important;
        }

        #left-sidebar {
            position: absolute;
            top: 15px;
            left: 15px;
            width: var(--panel-width);
            height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
            pointer-events: none;
            transform: scale(var(--ui-scale));
            transform-origin: top left;
        }

        .scroll-content {
            flex: 1;
            overflow-y: auto;
            pointer-events: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: none;
        }

        .scroll-content::-webkit-scrollbar {
            display: none;
        }

        .bottom-left-panel {
            position: absolute;
            bottom: 15px;
            left: 15px;
            pointer-events: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            width: var(--panel-width);
            padding: 10px;
            box-sizing: border-box;
            transform: scale(var(--ui-scale));
            transform-origin: bottom left;
        }

        .bottom-left-panel .ui-title-main {
            grid-column: span 2;
            font-size: 11px;
            margin-bottom: 4px;
            padding-bottom: 2px;
        }

        .bottom-left-panel .elegant-btn {
            width: 100%;
            font-size: 10px;
            height: 28px;
        }

        /* ‰øÆÂ§ç input file Ê†∑Âºè */
        .bottom-left-panel .elegant-btn {
            width: 100%;
            font-size: 10px;
            height: 28px;
            position: relative;
        }

        .elegant-btn input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .ui-title-main {
            font-family: 'SimSun', 'Songti SC', serif;
            font-size: 14px;
            font-weight: bold;
            color: #fff1c1;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            padding-bottom: 4px;
            margin-bottom: 6px;
            letter-spacing: 2px;
            text-align: center;
        }

        .ui-title-sub {
            font-size: 12px;
            color: #b0b0b5;
            margin-top: 6px;
            margin-bottom: 3px;
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .control-label {
            color: #aaa;
            font-size: 11px;
            font-weight: 700;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 5px;
        }

        .control-row {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-bottom: 4px;
        }

        .particle-scroll-container {
            max-height: 140px;
            overflow-y: auto;
            padding-right: 4px;
            margin-right: -4px;
            border-left: 2px solid rgba(212, 175, 55, 0.1);
            padding-left: 6px;
        }

        .particle-scroll-container::-webkit-scrollbar {
            width: 3px;
        }

        .particle-scroll-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 2px;
        }

        .particle-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.4);
            border-radius: 2px;
        }

        .elegant-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 5px 0;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            text-decoration: none;
        }

        .elegant-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #fff1c1;
            color: #fff;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }

        .elegant-btn:active {
            transform: scale(0.98);
        }

        .btn-red {
            border-color: #844;
            color: #eaa;
        }

        .btn-red:hover {
            background: #522;
            box-shadow: 0 0 15px rgba(255, 50, 50, 0.3);
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 3px 0;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 1px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 9px;
            width: 9px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -4px;
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.8);
            border: 1px solid #000;
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            background: #fff;
        }

        .input-glass {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #eebb66;
            padding: 3px;
            font-size: 10px;
            outline: none;
            transition: 0.3s;
            border-radius: 2px;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            height: 24px;
        }

        .input-glass:focus {
            border-color: #d4af37;
            background: rgba(0, 0, 0, 0.6);
        }

        select.input-glass {
            cursor: pointer;
        }

        select.input-glass option {
            background: #000;
            color: #d4af37;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 16px;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #title-container {
            position: absolute;
            top: 4%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: auto;
            cursor: move;
            z-index: 50;
            transition: color 0.2s;
            user-select: none;
            padding: 10px;
        }

        .title-line {
            margin: 0;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: #fceea7;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .top-left-panel {
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .interaction-grid {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }

        .direction-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 3px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dir-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 175, 55, 0.2);
            color: #d4af37;
            text-align: center;
            cursor: pointer;
            padding: 5px 0;
            border-radius: 2px;
            font-size: 11px;
            user-select: none;
            transition: 0.2s;
        }

        .dir-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #fff;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.2);
        }

        .dir-btn:active {
            background: #d4af37;
            color: #000;
        }

        #top-right-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            z-index: 50;
        }

        #webcam-wrapper {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 160px;
            height: 120px;
            border: 1px solid rgba(212, 175, 55, 0.5);
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            overflow: hidden;
            z-index: 20;
            pointer-events: auto;
            background: #000;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        #webcam-wrapper.camera-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
        }

        #webcam-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: block;
        }

        #cam-status {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 6px;
            height: 6px;
            background: #550000;
            border-radius: 50%;
            box-shadow: 0 0 4px #ff0000;
            z-index: 30;
            transition: 0.2s;
        }

        #cam-status.active {
            background: #00ff00;
            box-shadow: 0 0 6px #00ff00;
        }

        #delete-manager {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 60;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        #photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 70%;
            height: 60%;
            overflow-y: auto;
            justify-content: center;
            padding: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        .photo-item {
            width: 80px;
            height: 80px;
            position: relative;
            border: 1px solid #d4af37;
            transition: 0.2s;
            cursor: pointer;
        }

        .photo-item:hover {
            transform: scale(1.1);
            border-color: #fff;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-x {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #900;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid #fff;
        }

        .manager-title {
            color: #d4af37;
            font-size: 20px;
            font-family: 'Microsoft YaHei', serif;
            letter-spacing: 2px;
        }

        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-top: 2px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: #d4af37;
            font-size: 12px;
            letter-spacing: 4px;
            margin-top: 25px;
            font-family: 'Cinzel', serif;
            opacity: 0.8;
        }

        #gesture-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: rgba(212, 175, 55, 0.7);
            font-size: 10px;
            pointer-events: none;
            text-shadow: 0 0 5px #000;
            z-index: 5;
        }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
    </script>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">SYSTEM INITIALIZING</div>
    </div>
    <div id="canvas-container"></div>
    <div id="title-container">
        <h1 id="display-line1" class="title-line">Á™¶ÈõÖÂ©∑</h1>
        <h1 id="display-line2" class="title-line">Merry Christmas</h1>
    </div>
    <div id="ui-layer">
        <div id="top-right-controls"><button class="elegant-btn glass-panel" id="fs-btn" onclick="toggleFullScreen()"
                style="padding: 6px 12px;">‚õ∂ ÂÖ®Â±èÊòæÁ§∫</button><button class="elegant-btn glass-panel" id="toggle-ui-btn"
                onclick="toggleUI()" style="padding: 6px 12px;">üëÅ ÈöêËóèÁïåÈù¢</button></div>
        <div id="left-sidebar">
            <div class="top-left-panel glass-panel">
                <div class="ui-title-main">Âú∫ÊôØÂÆöÂà∂</div>
                <div class="ui-title-sub">Á•ùÁ¶èËØ≠ÂΩï</div>
                <div class="control-row"><input type="text" id="input-line1" class="input-glass" placeholder="Á¨¨‰∏ÄË°åÊñáÂ≠ó"
                        oninput="updateTextConfig()"><input type="text" id="input-line2" class="input-glass"
                        placeholder="Á¨¨‰∫åË°åÊñáÂ≠ó" oninput="updateTextConfig()" style="margin-top:2px;"></div>
                <div class="ui-title-sub">Â≠ó‰ΩìÈ£éÊ†º</div><select id="font-select" class="input-glass"
                    onchange="updateTextConfig()">
                    <option value="style1">‰π¶Ê≥ïÈüµÂë≥</option>
                    <option value="style2">Âè§ÂÖ∏Ë°¨Á∫ø</option>
                    <option value="style3">‰ºòÈõÖÊâãÂÜô</option>
                    <option value="style4">Ëâ∫ÊúØÁ∫øÊù°</option>
                    <option value="style5">Â§çÂè§ÈáçÁ£Ö</option>
                </select>
                <div class="control-row">
                    <div class="ui-title-sub" style="margin-top:6px;">Â§ßÂ∞è & È¢úËâ≤</div>
                    <div style="display:flex; gap:8px; align-items:center;"><input type="range" min="50" max="250"
                            value="140" id="slider-fontsize" oninput="updateTextConfig()"><input type="color"
                            id="color-picker" value="#fceea7" oninput="updateTextConfig()"
                            style="width:30px; height:20px; border:none;"></div>
                </div>
                <div class="ui-title-sub"
                    style="border-top:1px solid rgba(255,255,255,0.05); padding-top:6px; margin-top:6px;">ËÉåÊôØÈü≥‰πê</div>
                <div style="display:flex; gap:8px; margin-bottom:4px;"><button class="elegant-btn"
                        onclick="toggleMusicPlay()" id="play-btn" style="flex:2; font-size:14px;">‚èØ</button><button
                        class="elegant-btn" onclick="replayMusic()" style="flex:1; font-size:14px;">‚ü≤</button></div>
                <div class="control-row"><span class="control-label" style="text-align:center;">Èü≥ÈáèË∞ÉËäÇ</span><input
                        type="range" min="0" max="100" value="50" id="slider-volume" oninput="updateVolume(this.value)">
                </div>
                <div class="ui-title-sub"
                    style="border-top:1px solid rgba(255,255,255,0.05); padding-top:6px; margin-top:6px;">Á≤íÂ≠êÊéßÂà∂</div>
                <div class="particle-scroll-container">
                    <div class="control-row"><span class="control-label">Ë£ÖÈ•∞ÂØÜÂ∫¶ (Ê†ë)</span><input type="range" min="500"
                            max="3000" value="1500" id="slider-tree"></div>
                    <div class="control-row"><span class="control-label">ÊòüÂ∞òÂØÜÂ∫¶ (ËÉåÊôØ)</span><input type="range" min="500"
                            max="5000" value="2500" id="slider-dust"></div>
                    <div class="control-row"><span class="control-label">Èõ™Ëä±Êï∞Èáè</span><input type="range" min="0"
                            max="3000" step="100" value="1500" id="slider-snow-count" onchange="updateSnowSettings()">
                    </div>
                    <div class="control-row"><span class="control-label">Èõ™Ëä±Â§ßÂ∞è</span><input type="range" min="0.05"
                            max="0.3" step="0.01" value="0.12" id="slider-snow-size" onchange="updateSnowSettings()">
                    </div>
                    <div class="control-row"><span class="control-label">‰∏ãËêΩÈÄüÂ∫¶</span><input type="range" min="1.0"
                            max="8.0" step="0.5" value="3.5" id="slider-snow-speed"
                            oninput="updateSnowSpeed(this.value)"></div>
                </div><button class="elegant-btn" style="width:100%; margin-top:8px;"
                    onclick="applyParticleSettings()">‚ö° ÈáçÁΩÆÂú∫ÊôØ</button>
            </div>
            <div class="top-left-panel glass-panel">
                <div class="ui-title-main">‰∫§‰∫í‰∏≠Êéß</div>
                <div class="ui-title-sub">ÂΩ¢ÊÄÅÂàáÊç¢</div>
                <div class="interaction-grid"><button class="elegant-btn" style="flex:1;" onclick="setMode('TREE')">ËÅöÂêà
                        (Space)</button><button class="elegant-btn" style="flex:1;" onclick="setMode('SCATTER')">Êï£ÂºÄ
                        (Z)</button></div><button class="elegant-btn" style="width:100%;"
                    onclick="triggerPhotoGrab()">ÊäìÂèñÁÖßÁâá (X)</button>
                <div class="control-row" style="margin-top:8px;"><span class="control-label">ÊóãËΩ¨ÈÄüÂ∫¶ (Êï£ÂºÄ)</span><input
                        type="range" min="0.1" max="5.0" step="0.1" value="1.4"
                        oninput="updateRotationSpeed(this.value)"></div>
                <div class="direction-pad">
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('up')" onmouseup="stopRotate()"
                        onmouseleave="stopRotate()">‚ñ≤</div>
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('left')" onmouseup="stopRotate()"
                        onmouseleave="stopRotate()">‚óÄ</div>
                    <div class="dir-btn" onclick="resetRotation()" style="font-size:10px;">‚óè</div>
                    <div class="dir-btn" onmousedown="startRotate('right')" onmouseup="stopRotate()"
                        onmouseleave="stopRotate()">‚ñ∂</div>
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('down')" onmouseup="stopRotate()"
                        onmouseleave="stopRotate()">‚ñº</div>
                    <div></div>
                </div>
                <div class="ui-title-sub" style="margin-top:8px;">È¢úËâ≤Ê®°Âºè</div>
                <div class="interaction-grid">
                    <select id="color-mode-select" class="input-glass" style="flex:2">
                        <option value="romantic">ËìùÁ≤â</option>
                        <option value="christmas">Âú£ËØû</option>
                        <option value="red">Á∫¢Ëâ≤</option>
                        <option value="purple">Á¥´Ëâ≤</option>
                    </select>
                    <button class="elegant-btn" id="color-prev-btn" style="flex:1">‰∏ä‰∏Ä</button>
                    <button class="elegant-btn" id="color-next-btn" style="flex:1">‰∏ã‰∏Ä</button>
                </div>
                <div class="control-row"><span class="control-label" style="text-align:center;">Âø´Êç∑ÈîÆ: C/V Êàñ 1-4</span></div>
            </div>
        </div>
        <div class="bottom-left-panel glass-panel">
            <div class="ui-title-main" style="font-size:12px; margin-bottom:5px;">ËµÑÊ∫êÁÆ°ÁêÜ</div><label class="elegant-btn">
                + ‰∏ä‰º†ÁÖßÁâá <input type="file" id="file-input" multiple accept="image/*"> </label><button class="elegant-btn"
                onclick="openDeleteManager()">‚ñ£ ÁÆ°ÁêÜÁÖßÁâá</button><label class="elegant-btn" id="music-upload-label"> ‚ô´ ËÉåÊôØÈü≥‰πê
                <input type="file" id="music-input" accept=".mp3,audio/mpeg"> </label><button class="elegant-btn"
                id="toggle-cam-btn" onclick="toggleCameraDisplay()">üì∑ ÈöêËóèÁîªÈù¢</button>
        </div>
    </div>
    <div id="gesture-hint">Ê≠£Âú®ÂàùÂßãÂåñÁ≥ªÁªü...</div>
    <div id="webcam-wrapper"><canvas id="webcam-canvas" width="320" height="240"></canvas>
        <div id="cam-status"></div>
    </div><video id="webcam-video" autoplay playsinline muted style="display:none"></video>
    <div id="delete-manager" class="hidden">
        <div class="manager-title">ÁÖßÁâáÂ∫ìÁÆ°ÁêÜ</div>
        <div id="photo-grid"></div>
        <div class="manager-actions"><button class="elegant-btn btn-red glass-panel" onclick="clearAllPhotos()"
                style="padding: 8px 20px;">Ê∏ÖÁ©∫ÊâÄÊúâ</button><button class="elegant-btn glass-panel"
                onclick="closeDeleteManager()" style="padding: 8px 20px;">ÂÖ≥Èó≠</button></div>
    </div>
    <script type="module">import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { BokehPass } from 'three/addons/postprocessing/BokehPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { FXAAShader } from 'three/addons/shaders/FXAAShader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        const DB_NAME = "GrandTreeDB_v17_Clean";
        const EXPORTED_DATA = null;

        let CONFIG = {
            colors: { bg: 0x000000, champagneGold: 0xffaed9, deepGreen: 0x2f6fd1, accentRed: 0xff6699 },
            particles: { count: 1500, dustCount: 2500, treeHeight: 24, treeRadius: 8 },
            snow: { count: 1500, range: 70, speed: 3.5, sizeBase: 0.12, sizeVar: 0.1 },
            camera: { z: 50 },
            interaction: { rotationSpeed: 1.4, grabRadius: 0.25 },
            showTopStar: true
        };

        const STATE = { mode: 'TREE', focusTarget: null, focusType: 0, hand: { detected: false, x: 0, y: 0 }, rotation: { x: 0, y: 0 }, uiVisible: true, cameraVisible: true, colorModeIndex: 0, lastColorSwitch: 0, handLastX: 0, lastGallerySwitch: 0, gallery: { radius: 12, height: 1.2, speed: 0.5, interval: 3.0, band: 1.2, scale: 3.0, focusScale: 4.2 } };
        let manualRotateState = { x: 0, y: 0 };
        const FONT_STYLES = { 'style1': { font: "'Ma Shan Zheng', cursive", spacing: "4px", shadow: "2px 2px 8px rgba(180,50,50,0.8)", transform: "none" }, 'style2': { font: "'Cinzel', serif", spacing: "6px", shadow: "0 0 20px rgba(255,215,0,0.5)", transform: "none" }, 'style3': { font: "'Great Vibes', cursive", spacing: "1px", shadow: "0 0 15px rgba(255,200,255,0.7)", transform: "none" }, 'style4': { font: "'Monoton', cursive", spacing: "1px", shadow: "0 0 10px #fff", transform: "none" }, 'style5': { font: "'Abril Fatface', cursive", spacing: "0px", shadow: "0 5px 15px rgba(0,0,0,0.8)", transform: "none" } };
        const ROMANTIC_PALETTE = [0xcfe9ff, 0xaad4ff, 0x77b8ff, 0x8fc8ff, 0x66a3ff, 0x99e0ff, 0xb8f1ff, 0xffcfe8, 0xffb7c5, 0xff8fa3, 0xffaed9, 0xffd0e8];
        const COLOR_MODES = { romantic: ROMANTIC_PALETTE, christmas: [0xff0000,0xcc0000,0xaa0000,0x00aa00,0x008000,0x006600,0xffd700,0xffee66,0xf4e04d,0xd4af37,0xffc107,0xffe082], red: [0xff0000,0xff3333,0xff6666,0xcc0000,0xff4444,0xff7777,0xff5252,0xff8a80,0xe57373,0xef5350,0xf06292,0xff6f61], purple: [0xbb86fc,0xa066ff,0x8a2be2,0x7b68ee,0x9966cc,0xda70d6,0xee82ee,0xd8bfd8,0x9400d3,0x6a0dad,0xaf8ff7,0xc5a3ff] };
        const COLOR_MODE_ORDER = ['romantic','christmas','red','purple'];
        let ACTIVE_PALETTE = COLOR_MODES.romantic;

        let db;
        function initDB() { if (EXPORTED_DATA) return Promise.resolve(null); return new Promise(r => { const q = indexedDB.open(DB_NAME, 1); q.onupgradeneeded = e => { const d = e.target.result; if (!d.objectStoreNames.contains('photos')) d.createObjectStore('photos', { keyPath: "id" }); if (!d.objectStoreNames.contains('music')) d.createObjectStore('music', { keyPath: "id" }) }; q.onsuccess = e => { db = e.target.result; r(db) }; q.onerror = () => r(null) }); }
        function savePhotoToDB(b) { if (!db) return null; const t = db.transaction('photos', "readwrite"); const i = Date.now() + Math.random().toString(); t.objectStore('photos').add({ id: i, data: b }); return i; }
        function loadPhotosFromDB() { if (EXPORTED_DATA) return Promise.resolve(EXPORTED_DATA.photos || []); if (!db) return Promise.resolve([]); return new Promise(r => { db.transaction('photos', "readonly").objectStore('photos').getAll().onsuccess = e => r(e.target.result) }); }
        function deletePhotoFromDB(i) { if (db) db.transaction('photos', "readwrite").objectStore('photos').delete(i); }
        function clearPhotosDB() { if (db) db.transaction('photos', "readwrite").objectStore('photos').clear(); }
        function saveMusicToDB(b) { if (!db) return; const t = db.transaction('music', "readwrite"); t.objectStore('music').put({ id: 'bgm', data: b }); }
        function loadMusicFromDB() { if (EXPORTED_DATA && EXPORTED_DATA.music) return Promise.resolve(dataURLtoBlob(EXPORTED_DATA.music)); if (!db) return Promise.resolve(null); return new Promise(r => { db.transaction('music', "readonly").objectStore('music').get('bgm').onsuccess = e => r(e.target.result ? e.target.result.data : null) }); }
        function dataURLtoBlob(dataurl) { var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); while (n--) { u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], { type: mime }); }

        let scene, camera, renderer, composer, mainGroup, particleSystem = [], photoMeshGroup = new THREE.Group(), snowInstancedMesh, snowDummy = new THREE.Object3D(), snowData = [], clock = new THREE.Clock(), handLandmarker, videoElement, caneTexture, haloTexture, bgmAudio = new Audio(), fxaaPass, bokehPass, bloomPass; bgmAudio.loop = true; let isMusicPlaying = false;

        async function loadAssetsFromManifest() {
            try {
                const res = await fetch('assets/photos.json', { cache: 'no-cache' });
                if (!res.ok) return false;
                const j = await res.json();
                const photos = Array.isArray(j.photos) ? j.photos : [];
                if (photos.length > 0) {
                    photoMeshGroup.clear();
                    particleSystem = particleSystem.filter(p => p.type !== 'PHOTO');
                    for (const u of photos) window.createPhotoFromURL(u, u);
                }
                if (j.music) {
                    bgmAudio.src = j.music;
                    try { await bgmAudio.play(); isMusicPlaying = true; updatePlayBtnUI(true); } catch (e) { updatePlayBtnUI(false); document.body.addEventListener('click', () => { if (!isMusicPlaying) toggleMusicPlay(); }, { once: true }); }
                }
                return true;
            } catch (e) {
                return false;
            }
        }

        async function init() {
            if (EXPORTED_DATA) {
                document.body.classList.add('exported-mode');
                CONFIG = EXPORTED_DATA.config;
                setTimeout(() => applyTextConfig(EXPORTED_DATA.text.fontKey, EXPORTED_DATA.text.line1, EXPORTED_DATA.text.line2, EXPORTED_DATA.text.size, EXPORTED_DATA.text.color), 100);
            }

            initThree(); setupEnvironment(); setupLights(); createTextures(); createParticles(); createDust(); createSnow(); createDefaultPhotos(); setupPostProcessing(); setupEvents(); animate();

            const loader = document.getElementById('loader');
            if (loader) { loader.style.opacity = 0; setTimeout(() => loader.remove(), 500); }

            try {
                await initDB();
                if (!EXPORTED_DATA) loadTextConfig();

                const assetsLoaded = await loadAssetsFromManifest();
                if (!assetsLoaded) {
                    const ps = await loadPhotosFromDB();
                    if (ps?.length > 0) { photoMeshGroup.clear(); particleSystem = particleSystem.filter(p => p.type !== 'PHOTO'); ps.forEach(i => createPhotoTexture(i.data, i.id)); }
                    const ms = await loadMusicFromDB();
                    if (ms) {
                        bgmAudio.src = URL.createObjectURL(ms);
                        try { await bgmAudio.play(); isMusicPlaying = true; updatePlayBtnUI(true); } catch (e) { updatePlayBtnUI(false); document.body.addEventListener('click', () => { if (!isMusicPlaying) toggleMusicPlay(); }, { once: true }); }
                    }
                }
            } catch (e) { console.warn(e); }

            initMediaPipe();
            initDraggableTitle();

            setMode('TREE');
        }

        function initDraggableTitle() { const t = document.getElementById('title-container'); let d = false, o = { x: 0, y: 0 }; t.onmousedown = e => { d = true; const r = t.getBoundingClientRect(); o.x = e.clientX - r.left; o.y = e.clientY - r.top; t.style.transform = 'none'; t.style.left = r.left + 'px'; t.style.top = r.top + 'px' }; window.onmousemove = e => { if (d) { t.style.left = (e.clientX - o.x) + 'px'; t.style.top = (e.clientY - o.y) + 'px' } }; window.onmouseup = () => d = false; }
        window.toggleUI = () => { STATE.uiVisible = !STATE.uiVisible; document.getElementById('left-sidebar').classList.toggle('panel-hidden', !STATE.uiVisible); document.querySelector('.bottom-left-panel').classList.toggle('panel-hidden', !STATE.uiVisible); };
        window.toggleCameraDisplay = () => { STATE.cameraVisible = !STATE.cameraVisible; document.getElementById('webcam-wrapper').classList.toggle('camera-hidden', !STATE.cameraVisible); };
        window.toggleFullScreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
        function loadTextConfig() { const s = JSON.parse(localStorage.getItem('v16_text_config')); if (s) { document.getElementById('input-line1').value = s.line1 || ""; document.getElementById('input-line2').value = s.line2 || ""; document.getElementById('font-select').value = s.fontKey || "style1"; document.getElementById('slider-fontsize').value = s.size || 140; document.getElementById('color-picker').value = s.color || "#fceea7"; applyTextConfig(s.fontKey, s.line1, s.line2, s.size || 140, s.color || "#fceea7"); } else { document.getElementById('input-line1').value = "Á™¶ÈõÖÂ©∑"; document.getElementById('input-line2').value = "Merry Christmas"; document.getElementById('font-select').value = "style1"; document.getElementById('slider-fontsize').value = 140; document.getElementById('color-picker').value = "#fceea7"; applyTextConfig("style1", "Á™¶ÈõÖÂ©∑", "Merry Christmas", 140, "#fceea7"); } }
        window.updateTextConfig = () => { const k = document.getElementById('font-select').value, l1 = document.getElementById('input-line1').value, l2 = document.getElementById('input-line2').value, s = document.getElementById('slider-fontsize').value, c = document.getElementById('color-picker').value; localStorage.setItem('v16_text_config', JSON.stringify({ fontKey: k, line1: l1, line2: l2, size: s, color: c })); applyTextConfig(k, l1, l2, s, c); };
        function applyTextConfig(k, l1, l2, s, c) { const st = FONT_STYLES[k] || FONT_STYLES['style1']; const t1 = document.getElementById('display-line1'), t2 = document.getElementById('display-line2'), ct = document.getElementById('title-container'); ct.style.fontFamily = st.font; t1.innerText = l1; t2.innerText = l2; t1.style.letterSpacing = st.spacing; t2.style.letterSpacing = st.spacing; t1.style.textShadow = st.shadow; t2.style.textShadow = st.shadow; t1.style.textTransform = st.transform; t2.style.textTransform = st.transform; t1.style.color = c; t2.style.color = c; t1.style.fontSize = (0.48 * s) + "px"; t2.style.fontSize = (0.48 * s) + "px"; }

        window.toggleMusicPlay = () => { if (!bgmAudio.src) return alert("ËØ∑ÂÖà‰∏ä‰º†Èü≥‰πê"); if (isMusicPlaying) { bgmAudio.pause(); isMusicPlaying = false; } else { bgmAudio.play(); isMusicPlaying = true; } updatePlayBtnUI(isMusicPlaying); };
        window.replayMusic = () => { if (!bgmAudio.src) return; bgmAudio.currentTime = 0; bgmAudio.play(); isMusicPlaying = true; updatePlayBtnUI(true); };
        window.updateVolume = (v) => { bgmAudio.volume = v / 100; };
        function updatePlayBtnUI(p) { document.getElementById('play-btn').innerText = p ? "‚è∏" : "‚èØ"; }

        window.updateRotationSpeed = (v) => { CONFIG.interaction.rotationSpeed = parseFloat(v); };
        window.updateColorModeUI = (m) => { const s = document.getElementById('color-mode-select'); if (s) s.value = m; };
        window.setColorMode = (m) => { const i = COLOR_MODE_ORDER.indexOf(m); if (i >= 0) { STATE.colorModeIndex = i; ACTIVE_PALETTE = COLOR_MODES[m]; window.applyParticleSettings(); window.updateColorModeUI(m); const h = document.getElementById('gesture-hint'); if (h) h.innerText = "È¢úËâ≤Ê®°Âºè: " + m; } };
        window.cycleColorMode = (d) => { const n = (STATE.colorModeIndex + (d > 0 ? 1 : -1) + COLOR_MODE_ORDER.length) % COLOR_MODE_ORDER.length; window.setColorMode(COLOR_MODE_ORDER[n]); };

        window.setMode = function (mode) {
            const prev = STATE.mode;
            if (mode === 'GALLERY' && prev !== 'GALLERY') window.enterGalleryMode();
            STATE.mode = mode;
            STATE.focusTarget = null;
            const hint = document.getElementById('gesture-hint');
            if (mode === 'TREE') hint.innerText = "Áä∂ÊÄÅ: ËÅöÂêà (Âú£ËØûÊ†ë)";
            else if (mode === 'SCATTER') hint.innerText = "Áä∂ÊÄÅ: Êï£ÂºÄ (Êòü‰∫ë)";
            else if (mode === 'FOCUS') hint.innerText = "Áä∂ÊÄÅ: ÊäìÂèñÁÖßÁâá";
            else if (mode === 'GALLERY') hint.innerText = "Áä∂ÊÄÅ: Â±ïÁ§∫ (Ëé´ÊØî‰πåÊñØÁéØ)";
        }
        window.enterGalleryMode = () => { const ps = particleSystem.filter(p => p.type === 'PHOTO'); STATE.galleryCount = ps.length; const n = ps.length; for (let i = 0; i < n; i++) { const p = ps[i]; p.galleryIndex = i; p.galleryUBase = (i / Math.max(1, n)) * Math.PI * 2; p.galleryV = ((i % 2 === 0) ? 1 : -1) * (STATE.gallery.band * 0.5); } };

        window.triggerPhotoGrab = () => {
            let cp = null, md = Infinity;
            STATE.focusType = Math.floor(Math.random() * 4);
            particleSystem.filter(p => p.type === 'PHOTO').forEach(p => {
                p.mesh.updateMatrixWorld();
                const pos = new THREE.Vector3();
                p.mesh.getWorldPosition(pos);
                const sp = pos.project(camera);
                const d = Math.hypot(sp.x, sp.y);
                if (sp.z < 1 && d < CONFIG.interaction.grabRadius) {
                    if (d < md) { md = d; cp = p.mesh; }
                }
            });

            if (cp) {
                setMode('FOCUS');
                STATE.focusTarget = cp;
            } else {
                setMode('SCATTER');
            }
        };

        window.startRotate = (d) => { if (d === 'up') manualRotateState.x = -1; if (d === 'down') manualRotateState.x = 1; if (d === 'left') manualRotateState.y = -1; if (d === 'right') manualRotateState.y = 1; };
        window.stopRotate = () => { manualRotateState = { x: 0, y: 0 }; };
        window.resetRotation = () => { STATE.rotation = { x: 0, y: 0 }; if (STATE.mode !== 'TREE') setMode('TREE'); };

        // ================= V17.6.5: UI + Keyboard =================
        window.setupEvents = function() {
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            if (fxaaPass) fxaaPass.material.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
        });

        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = e.target.files; if (!files.length) return;
            Array.from(files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result;
                    const id = savePhotoToDB(base64);
                    createPhotoTexture(base64, id);
                }
                reader.readAsDataURL(f);
            });
        });
        document.getElementById('music-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                saveMusicToDB(file);
                bgmAudio.src = URL.createObjectURL(file);
                bgmAudio.play().then(() => { isMusicPlaying = true; updatePlayBtnUI(true); }).catch(console.error);
            }
        });

        // --- Keyboard Controls ---
        window.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            const k = e.key.toLowerCase();
            const code = e.code;

            if (k === 'h') window.toggleUI();

            if (code === 'Space') { e.preventDefault(); setMode('TREE'); }
            if (k === 'z') setMode('SCATTER');
            if (k === 'x') triggerPhotoGrab();
            if (k === 'g') setMode('GALLERY');
            if (code === 'Escape') setMode('TREE');

            if (code === 'ArrowUp') manualRotateState.x = -1;
            if (code === 'ArrowDown') manualRotateState.x = 1;
            if (code === 'ArrowLeft') manualRotateState.y = -1;
            if (code === 'ArrowRight') manualRotateState.y = 1;
            if (k === 'c') window.cycleColorMode(1);
            if (k === 'v') window.cycleColorMode(-1);
            if (k === '1') window.setColorMode('romantic');
            if (k === '2') window.setColorMode('christmas');
            if (k === '3') window.setColorMode('red');
            if (k === '4') window.setColorMode('purple');
            if (k === 'g') setMode('GALLERY');
            if (code === 'Escape') setMode('TREE');
        });

        window.addEventListener('keyup', (e) => {
            const code = e.code;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(code)) {
                manualRotateState = { x: 0, y: 0 };
            }
        });
        }

        function initThree() { const c = document.getElementById('canvas-container'); scene = new THREE.Scene(); scene.background = new THREE.Color(CONFIG.colors.bg); scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.008); camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(0.2, 3.5, CONFIG.camera.z); renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: "high-performance" }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); renderer.toneMapping = THREE.ReinhardToneMapping; renderer.toneMappingExposure = 2.2; c.appendChild(renderer.domElement); mainGroup = new THREE.Group(); scene.add(mainGroup); camera.lookAt(mainGroup.position); }
        function setupEnvironment() { const p = new THREE.PMREMGenerator(renderer); scene.environment = p.fromScene(new RoomEnvironment(), 0.04).texture; }
        function setupLights() { scene.add(new THREE.AmbientLight(0xffffff, 0.6)); const i = new THREE.PointLight(0x66aaff, 2, 20); i.position.set(0, 5, 0); mainGroup.add(i); const s1 = new THREE.SpotLight(0xffbbdd, 1200); s1.position.set(30, 40, 40); s1.angle = 0.5; s1.penumbra = 0.5; scene.add(s1); const s2 = new THREE.SpotLight(0x6688ff, 600); s2.position.set(-30, 20, -30); scene.add(s2); const f = new THREE.DirectionalLight(0xddeeff, 0.8); f.position.set(0, 0, 50); scene.add(f); const h = new THREE.HemisphereLight(0xddeeff, 0x223344, 0.5); scene.add(h); }
        function setupPostProcessing() { const r = new RenderPass(scene, camera); bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.5, 0.9); bloomPass.threshold = 0.6; bloomPass.strength = 0.55; bloomPass.radius = 0.5; composer = new EffectComposer(renderer); composer.addPass(r); fxaaPass = new ShaderPass(FXAAShader); fxaaPass.material.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight); composer.addPass(fxaaPass); composer.addPass(bloomPass); bokehPass = new BokehPass(scene, camera, { focus: 30.0, aperture: 0.0, maxblur: 0.0 }); composer.addPass(bokehPass); bokehPass.enabled = false; }
        function createTextures() { const c = document.createElement('canvas'); c.width = 128; c.height = 128; const x = c.getContext('2d'); x.fillStyle = '#ffffff'; x.fillRect(0, 0, 128, 128); let k = 0; for (let i = -128; i < 256; i += 32) { x.fillStyle = (k++ % 2 === 0) ? '#3f7dd6' : '#cc4a7a'; x.beginPath(); x.moveTo(i, 0); x.lineTo(i + 32, 128); x.lineTo(i + 16, 128); x.lineTo(i - 16, 0); x.closePath(); x.fill(); } caneTexture = new THREE.CanvasTexture(c); caneTexture.wrapS = caneTexture.wrapT = THREE.RepeatWrapping; caneTexture.repeat.set(3, 3); const hc = document.createElement('canvas'); hc.width = 128; hc.height = 128; const hx = hc.getContext('2d'); const g = hx.createRadialGradient(64, 64, 0, 64, 64, 64); g.addColorStop(0, 'rgba(143,210,255,0.9)'); g.addColorStop(0.5, 'rgba(143,210,255,0.5)'); g.addColorStop(1, 'rgba(143,210,255,0)'); hx.fillStyle = g; hx.beginPath(); hx.arc(64, 64, 64, 0, Math.PI * 2); hx.fill(); haloTexture = new THREE.CanvasTexture(hc); haloTexture.colorSpace = THREE.SRGBColorSpace; }

        window.updateSnowSettings = () => { CONFIG.snow.sizeBase = parseFloat(document.getElementById('slider-snow-size').value); CONFIG.snow.count = parseInt(document.getElementById('slider-snow-count').value); createSnow(); };
        window.updateSnowSpeed = (v) => { CONFIG.snow.speed = parseFloat(v); };
        function createSnow() {
            if (snowInstancedMesh) { scene.remove(snowInstancedMesh); snowInstancedMesh.geometry.dispose(); snowInstancedMesh.material.dispose(); snowInstancedMesh = null; snowData = []; }
            if (CONFIG.snow.count <= 0) return;
            const g = new THREE.IcosahedronGeometry(CONFIG.snow.sizeBase, 0);
            const m = new THREE.MeshPhysicalMaterial({ color: 0xffffff, metalness: 0, roughness: 0.15, transmission: 0.9, thickness: 0.5, envMapIntensity: 1.5, clearcoat: 1, clearcoatRoughness: 0.1, ior: 1.33 });
            snowInstancedMesh = new THREE.InstancedMesh(g, m, CONFIG.snow.count); snowInstancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            for (let i = 0; i < CONFIG.snow.count; i++) {
                snowDummy.position.set((Math.random() - 0.5) * CONFIG.snow.range, Math.random() * CONFIG.snow.range, (Math.random() - 0.5) * CONFIG.snow.range);
                snowDummy.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                const s = 0.5 + Math.random() * CONFIG.snow.sizeVar; snowDummy.scale.set(s, s, s); snowDummy.updateMatrix();
                snowInstancedMesh.setMatrixAt(i, snowDummy.matrix);
                snowData.push({ vy: (Math.random() * 0.5 + 0.8), rx: (Math.random() - 0.5) * 2, ry: (Math.random() - 0.5) * 2, rz: (Math.random() - 0.5) * 2 });
            } scene.add(snowInstancedMesh);
        }

        class Particle {
            constructor(m, t, d = false, index = null, totalCount = null) { this.mesh = m; this.type = t; this.isDust = d; this.index = index; this.totalCount = totalCount; this.posTree = new THREE.Vector3(); this.posScatter = new THREE.Vector3(); this.baseScale = m.scale.x; this.photoId = null; const s = (t === 'PHOTO') ? 0.3 : 2.0; this.spinSpeed = new THREE.Vector3((Math.random() - 0.5) * s, (Math.random() - 0.5) * s, (Math.random() - 0.5) * s); this.calcPos(); }
            calcPos() { const h = CONFIG.particles.treeHeight; if (!this.isDust && this.type !== 'PHOTO' && this.index !== null && this.totalCount !== null) { const arms = 3; const branchIndex = this.index % arms; const levelIndex = Math.floor(this.index / arms); const levels = Math.max(1, Math.ceil(this.totalCount / arms)); const t = levels > 1 ? levelIndex / (levels - 1) : 0; const baseRadius = CONFIG.particles.treeRadius; const y = (t * h) - (h / 2); const radius = baseRadius * (1.0 - t * 0.95); const turns = 6; const angle = turns * 2 * Math.PI * t + (branchIndex * 2 * Math.PI / arms); const x = radius * Math.cos(angle); const z = radius * Math.sin(angle); this.posTree.set(x, y, z); } else { let t = Math.pow(Math.random(), 0.8); const y = (t * h) - (h / 2); let rm = Math.max(0.5, CONFIG.particles.treeRadius * (1.0 - t)); const a = t * 50 * Math.PI + Math.random() * Math.PI; const r = rm * (0.8 + Math.random() * 0.4); this.posTree.set(Math.cos(a) * r, y, Math.sin(a) * r); } let rs = this.isDust ? (12 + Math.random() * 20) : (8 + Math.random() * 12); const th = Math.random() * Math.PI * 2, ph = Math.acos(2 * Math.random() - 1); this.posScatter.set(rs * Math.sin(ph) * Math.cos(th), rs * Math.sin(ph) * Math.sin(th), rs * Math.cos(ph)); }
            update(dt, mode, ft) {
                let tg = this.posTree; let u = 0; if (mode === 'SCATTER') tg = this.posScatter; else if (mode === 'FOCUS') { if (this.mesh === ft) { let off = new THREE.Vector3(0, 1, 38); if (STATE.focusType === 1) off.set(-4, 2, 35); else if (STATE.focusType === 2) off.set(3, 0, 32); else if (STATE.focusType === 3) off.set(0, -2.5, 30); const im = new THREE.Matrix4().copy(mainGroup.matrixWorld).invert(); tg = off.applyMatrix4(im); } else tg = this.posScatter; } else if (mode === 'GALLERY') { if (this.type === 'PHOTO') { const R = STATE.gallery.radius; const band = STATE.gallery.band; const H = STATE.gallery.height; u = clock.elapsedTime * STATE.gallery.speed + (this.galleryUBase || 0); const v = (this.galleryV || 0); const x = (R + v * Math.cos(u * 0.5)) * Math.cos(u); const y = v * Math.sin(u * 0.5) * H; const z = (R + v * Math.cos(u * 0.5)) * Math.sin(u); tg = new THREE.Vector3(x, y, z); } else tg = this.posScatter; }
                const ls = (mode === 'FOCUS' && this.mesh === ft) ? 8.0 : 4.0; this.mesh.position.lerp(tg, ls * dt);
                if (mode === 'SCATTER') { this.mesh.rotation.x += this.spinSpeed.x * dt; this.mesh.rotation.y += this.spinSpeed.y * dt; this.mesh.rotation.z += this.spinSpeed.z * dt; } else if (mode === 'TREE') { this.mesh.rotation.x = THREE.MathUtils.lerp(this.mesh.rotation.x, 0, dt); this.mesh.rotation.z = THREE.MathUtils.lerp(this.mesh.rotation.z, 0, dt); this.mesh.rotation.y += 0.5 * dt; } else if (mode === 'GALLERY' && this.type === 'PHOTO') { this.mesh.rotation.y = -u; this.mesh.rotation.z = u * 0.5; }
                if (mode === 'FOCUS' && this.mesh === ft) { this.mesh.lookAt(camera.position); if (STATE.focusType === 1) this.mesh.rotateZ(0.38); if (STATE.focusType === 2) this.mesh.rotateZ(-0.15); if (STATE.focusType === 3) this.mesh.rotateX(-0.4); }
                let s = this.baseScale; if (this.isDust) { s = this.baseScale * (0.8 + 0.4 * Math.sin(clock.elapsedTime * 4 + this.mesh.id)); if (mode === 'TREE') s = 0; } else if (mode === 'SCATTER' && this.type === 'PHOTO') s = this.baseScale * 2.5; else if (mode === 'FOCUS') { if (this.mesh === ft) { if (STATE.focusType === 2) s = 3.5; else if (STATE.focusType === 3) s = 4.8; else s = 3.0; } else s = this.baseScale * 0.8; } else if (mode === 'GALLERY' && this.type === 'PHOTO') { s = this.baseScale * STATE.gallery.scale; if (STATE.galleryCount > 0) { const fi = Math.floor(clock.elapsedTime / STATE.gallery.interval) % STATE.galleryCount; if (this.galleryIndex === fi) s = this.baseScale * STATE.gallery.focusScale; } } this.mesh.scale.lerp(new THREE.Vector3(s, s, s), 6 * dt);
                if (this.mesh.material && 'emissiveIntensity' in this.mesh.material) { let target = (mode === 'TREE') ? 0.15 : (mode === 'FOCUS' && this.mesh === ft) ? 0.45 : 0.35; if (mode === 'GALLERY' && this.type === 'PHOTO' && STATE.galleryCount > 0) { const fi = Math.floor(clock.elapsedTime / STATE.gallery.interval) % STATE.galleryCount; if (this.galleryIndex === fi) target = 0.5; } this.mesh.material.emissiveIntensity = THREE.MathUtils.lerp(this.mesh.material.emissiveIntensity || 0.3, target, 4 * dt); }
            }
        }

        function createParticles() {
            const sg = new THREE.SphereGeometry(0.5, 32, 32);
            const bg = new THREE.BoxGeometry(0.55, 0.55, 0.55);
            const c = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, -0.5, 0),
                new THREE.Vector3(0, 0.3, 0),
                new THREE.Vector3(0.1, 0.5, 0),
                new THREE.Vector3(0.3, 0.4, 0)
            ]);
            const cg = new THREE.TubeGeometry(c, 16, 0.08, 8, false);

            const baseGm = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.champagneGold,
                metalness: 1,
                roughness: 0.15,
                envMapIntensity: 1.2,
                emissive: 0x223344,
                emissiveIntensity: 0.25
            });
            const baseGrm = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.deepGreen,
                metalness: 0.2,
                roughness: 0.85,
                emissive: 0x112233,
                emissiveIntensity: 0.18
            });
            const baseRm = new THREE.MeshPhysicalMaterial({
                color: CONFIG.colors.accentRed,
                metalness: 0.25,
                roughness: 0.25,
                clearcoat: 1,
                emissive: 0x112233
            });
            const cm = new THREE.MeshStandardMaterial({
                map: caneTexture,
                roughness: 0.4
            });

            const total = CONFIG.particles.count;
            for (let i = 0; i < total; i++) {
                const r = Math.random();
                const col = ACTIVE_PALETTE[Math.floor(Math.random() * ACTIVE_PALETTE.length)];
                const emColor = new THREE.Color(col).multiplyScalar(0.35);
                let m, t;

                if (r < 0.4) {
                    const mat = baseGrm.clone();
                    mat.color.setHex(col);
                    mat.emissive.copy(emColor);
                    m = new THREE.Mesh(bg, mat);
                    t = 'BOX';
                } else if (r < 0.7) {
                    const mat = baseGm.clone();
                    mat.color.setHex(col);
                    mat.emissive.copy(emColor);
                    m = new THREE.Mesh(bg, mat);
                    t = 'GOLD_BOX';
                } else if (r < 0.92) {
                    const mat = baseGm.clone();
                    mat.color.setHex(col);
                    mat.emissive.copy(emColor);
                    m = new THREE.Mesh(sg, mat);
                    t = 'GOLD_SPHERE';
                } else if (r < 0.97) {
                    const mat = baseRm.clone();
                    mat.color.setHex(col);
                    mat.emissive.copy(new THREE.Color(col).multiplyScalar(0.45));
                    m = new THREE.Mesh(sg, mat);
                    t = 'RED';
                } else {
                    m = new THREE.Mesh(cg, cm);
                    t = 'CANE';
                }

                const s = 0.4 + Math.random() * 0.5;
                m.scale.set(s, s, s);
                m.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                mainGroup.add(m);
                particleSystem.push(new Particle(m, t, false, i, total));
            }
            if (CONFIG.showTopStar) {
                const spikes = 5, outer = 1.1, inner = 0.5; const shape = new THREE.Shape(); for (let i = 0; i < spikes * 2; i++) { const r = (i % 2 === 0) ? outer : inner; const a = (i / (spikes * 2)) * Math.PI * 2 - Math.PI / 2; const x = Math.cos(a) * r; const y = Math.sin(a) * r; if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y); } shape.closePath(); const geo = new THREE.ExtrudeGeometry(shape, { depth: 0.15, bevelEnabled: true, bevelSegments: 2, bevelSize: 0.05, bevelThickness: 0.05 }); geo.center(); const mat = new THREE.MeshStandardMaterial({ color: 0xcfe9ff, emissive: 0x8fd2ff, emissiveIntensity: 1, metalness: 1, roughness: 0.2 }); const st = new THREE.Mesh(geo, mat); st.position.set(0, CONFIG.particles.treeHeight / 2 + 1.2, 0); mainGroup.add(st); const glowMat = new THREE.SpriteMaterial({ map: haloTexture, color: 0xffffff, transparent: true, opacity: 1.0, blending: THREE.AdditiveBlending, depthWrite: false }); const glow = new THREE.Sprite(glowMat); glow.scale.set(3, 3, 1); glow.position.copy(st.position); mainGroup.add(glow);
            }
            mainGroup.add(photoMeshGroup);
        }
        function createDust() { const g = new THREE.TetrahedronGeometry(0.08, 0); for (let i = 0; i < CONFIG.particles.dustCount; i++) { const col = ACTIVE_PALETTE[Math.floor(Math.random() * ACTIVE_PALETTE.length)]; const m = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.6 + Math.random() * 0.3 }); const ms = new THREE.Mesh(g, m); ms.scale.setScalar(0.5 + Math.random()); mainGroup.add(ms); particleSystem.push(new Particle(ms, 'DUST', true)); } }
        function createDefaultPhotos() { const c = document.createElement('canvas'); c.width = 512; c.height = 512; const x = c.getContext('2d'); x.fillStyle = '#050505'; x.fillRect(0, 0, 512, 512); x.strokeStyle = '#eebb66'; x.lineWidth = 15; x.strokeRect(20, 20, 472, 472); x.font = '500 60px Times New Roman'; x.fillStyle = '#eebb66'; x.textAlign = 'center'; x.fillText("JOYEUX", 256, 230); x.fillText("NOEL", 256, 300); createPhotoTexture(c.toDataURL(), 'default'); }
        function createPhotoTexture(b, id) { const i = new Image(); i.src = b; i.onload = () => { const t = new THREE.Texture(i); t.colorSpace = THREE.SRGBColorSpace; t.needsUpdate = true; addPhotoToScene(t, id, i); } }
        window.createPhotoFromURL = (u, id) => { const i = new Image(); i.crossOrigin = 'anonymous'; i.src = u; i.onload = () => { const t = new THREE.Texture(i); t.colorSpace = THREE.SRGBColorSpace; t.needsUpdate = true; addPhotoToScene(t, id || u, i); } };
        function addPhotoToScene(t, id, imgObj) {
            const aspect = imgObj.width / imgObj.height; let w = 1.2, h = 1.2; if (aspect > 1) h = w / aspect; else w = h * aspect;
            const fg = new THREE.BoxGeometry(w + 0.2, h + 0.2, 0.05); const fm = new THREE.MeshStandardMaterial({ color: 0xc5a059, metalness: 0.6, roughness: 0.5, envMapIntensity: 0.5 }); const f = new THREE.Mesh(fg, fm); const pg = new THREE.PlaneGeometry(w, h); const pm = new THREE.MeshBasicMaterial({ map: t }); const p = new THREE.Mesh(pg, pm); p.position.z = 0.04; const g = new THREE.Group(); g.add(f); g.add(p); const s = 0.8; g.scale.set(s, s, s); photoMeshGroup.add(g); const pt = new Particle(g, 'PHOTO', false); pt.photoId = id; pt.texture = t; particleSystem.push(pt);
        }
        window.applyParticleSettings = () => { const ph = particleSystem.filter(p => p.type === 'PHOTO'); const tr = []; mainGroup.children.forEach(c => { if (c !== photoMeshGroup) tr.push(c) }); tr.forEach(c => mainGroup.remove(c)); particleSystem = [...ph]; CONFIG.particles.count = parseInt(document.getElementById('slider-tree').value); CONFIG.particles.dustCount = parseInt(document.getElementById('slider-dust').value); createParticles(); createDust(); createSnow(); };

        async function initMediaPipe() { videoElement = document.getElementById('webcam-video'); if (navigator.mediaDevices?.getUserMedia) { try { const s = await navigator.mediaDevices.getUserMedia({ video: true }); videoElement.srcObject = s; videoElement.onloadedmetadata = () => { videoElement.play(); renderWebcamPreview() }; } catch (e) { console.error(e) } } try { const v = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"); handLandmarker = await HandLandmarker.createFromOptions(v, { baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" }, runningMode: "VIDEO", numHands: 1 }); predictWebcam(); } catch (e) { console.warn(e) } }
        function renderWebcamPreview() { const c = document.getElementById('webcam-canvas'), x = c.getContext('2d', { willReadFrequently: true }); function d() { if (videoElement.readyState >= 2) x.drawImage(videoElement, 0, 0, c.width, c.height); requestAnimationFrame(d) } d() }
        let lvt = -1; async function predictWebcam() { if (videoElement && videoElement.currentTime !== lvt && handLandmarker) { lvt = videoElement.currentTime; const r = handLandmarker.detectForVideo(videoElement, performance.now()); processGestures(r); document.getElementById('cam-status').classList.toggle('active', r.landmarks.length > 0); } requestAnimationFrame(predictWebcam); }
        function processGestures(r) { if (r.landmarks && r.landmarks.length > 0) { STATE.hand.detected = true; const lm = r.landmarks[0]; STATE.hand.x = (lm[9].x - 0.5) * 2; STATE.hand.y = (lm[9].y - 0.5) * 2; const thumb = lm[4], index = lm[8], wrist = lm[0], middle = lm[12], ring = lm[16], pinky = lm[20]; const pd = Math.hypot(thumb.x - index.x, thumb.y - index.y); const od = Math.hypot(middle.x - wrist.x, middle.y - wrist.y); const di = Math.hypot(index.x - wrist.x, index.y - wrist.y); const dm = Math.hypot(middle.x - wrist.x, middle.y - wrist.y); const dr = Math.hypot(ring.x - wrist.x, ring.y - wrist.y); const dp = Math.hypot(pinky.x - wrist.x, pinky.y - wrist.y); const peace = di > 0.35 && dm > 0.35 && dr < 0.30 && dp < 0.30; const fist = di < 0.28 && dm < 0.28 && dr < 0.28 && dp < 0.28; const three = di > 0.35 && dm > 0.35 && dr > 0.35 && dp < 0.30; const now = performance.now(); if (STATE.mode === 'FOCUS') { if (pd > 0.1) setMode('SCATTER'); return; } if (STATE.mode === 'GALLERY') { if (now - STATE.lastColorSwitch > 700 && peace) { window.cycleColorMode(1); STATE.lastColorSwitch = now; } if (now - STATE.lastGallerySwitch > 700 && fist) { setMode('TREE'); STATE.lastGallerySwitch = now; } return; } if (pd < 0.05 && STATE.mode !== 'FOCUS') triggerPhotoGrab(); else if (od > 0.4) setMode('SCATTER'); else if (od < 0.2) setMode('TREE'); if (now - STATE.lastColorSwitch > 700) { if (peace) { window.cycleColorMode(1); STATE.lastColorSwitch = now; } else if (fist) { setMode('TREE'); STATE.lastColorSwitch = now; } } if (now - STATE.lastGallerySwitch > 700 && three && STATE.mode !== 'GALLERY') { setMode('GALLERY'); STATE.lastGallerySwitch = now; } } else STATE.hand.detected = false; }

        window.setupEvents = () => {
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); if (fxaaPass) fxaaPass.material.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight) });
            document.getElementById('file-input').addEventListener('change', e => { Array.from(e.target.files).forEach(f => { const r = new FileReader(); r.onload = ev => { const i = new Image(); i.src = ev.target.result; i.onload = () => { const id = savePhotoToDB(ev.target.result); createPhotoTexture(ev.target.result, id) } }; r.readAsDataURL(f) }) });
            document.getElementById('music-input').addEventListener('change', e => { const f = e.target.files[0]; if (f) { saveMusicToDB(f); bgmAudio.src = URL.createObjectURL(f); bgmAudio.play().then(() => { isMusicPlaying = true; updatePlayBtnUI(true) }).catch(console.error) } });

            // ÈîÆÁõò‰∫§‰∫í
            window.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            const code = e.code;
            const k = e.key.toLowerCase();

            if (k === 'h') window.toggleUI();
            if (code === 'Space') { e.preventDefault(); setMode('TREE'); }
            if (k === 'z') setMode('SCATTER');
            if (k === 'x') triggerPhotoGrab();

            if (code === 'ArrowUp') manualRotateState.x = -1;
            if (code === 'ArrowDown') manualRotateState.x = 1;
            if (code === 'ArrowLeft') manualRotateState.y = -1;
            if (code === 'ArrowRight') manualRotateState.y = 1;
            if (k === 'c') window.cycleColorMode(1);
            if (k === 'v') window.cycleColorMode(-1);
            if (k === '1') window.setColorMode('romantic');
            if (k === '2') window.setColorMode('christmas');
            if (k === '3') window.setColorMode('red');
            if (k === '4') window.setColorMode('purple');
        });
        window.addEventListener('keyup', (e) => {
            const code = e.code;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(code)) manualRotateState = { x: 0, y: 0 };
        });
        const cms = document.getElementById('color-mode-select');
        const cp = document.getElementById('color-prev-btn');
        const cn = document.getElementById('color-next-btn');
        if (cms) cms.addEventListener('change', (e) => { window.setColorMode(e.target.value); });
        if (cp) cp.addEventListener('click', () => window.cycleColorMode(-1));
        if (cn) cn.addEventListener('click', () => window.cycleColorMode(1));
        window.updateColorModeUI(COLOR_MODE_ORDER[STATE.colorModeIndex]);
        }
        window.openDeleteManager = async () => { document.getElementById('delete-manager').classList.remove('hidden'); const g = document.getElementById('photo-grid'); g.innerHTML = ''; const ps = await loadPhotosFromDB(); if (!ps || ps.length === 0) g.innerHTML = '<div style="color:#888;">ÊöÇÊó†ÁÖßÁâá</div>'; else ps.forEach(p => { const d = document.createElement('div'); d.className = 'photo-item'; const i = document.createElement('img'); i.className = 'photo-thumb'; i.src = p.data; const b = document.createElement('div'); b.className = 'delete-x'; b.innerText = 'X'; b.onclick = e => { e.stopPropagation(); confirmDelete(p.id, d) }; d.appendChild(i); d.appendChild(b); g.appendChild(d) }) }
        window.confirmDelete = (id, el) => { deletePhotoFromDB(id); el.remove(); const p = particleSystem.find(pa => pa.photoId === id); if (p) { photoMeshGroup.remove(p.mesh); particleSystem.splice(particleSystem.indexOf(p), 1) } }
        window.clearAllPhotos = () => { if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁÖßÁâáÂêóÔºü")) { clearPhotosDB(); particleSystem.filter(p => p.type === 'PHOTO').forEach(p => photoMeshGroup.remove(p.mesh)); particleSystem = particleSystem.filter(p => p.type !== 'PHOTO'); window.openDeleteManager() } }
        window.closeDeleteManager = () => { document.getElementById('delete-manager').classList.add('hidden') }

        function animate() {
            requestAnimationFrame(animate); const dt = clock.getDelta(); const et = clock.getElapsedTime();
            if (STATE.mode === 'TREE') { renderer.toneMappingExposure = 1.9; if (bloomPass) bloomPass.strength = 0.35; } else { renderer.toneMappingExposure = 2.2; if (bloomPass) bloomPass.strength = 0.55; }
            if (snowInstancedMesh && STATE.mode === 'TREE') {
                snowInstancedMesh.visible = true;
                for (let i = 0; i < CONFIG.snow.count; i++) {
                    snowInstancedMesh.getMatrixAt(i, snowDummy.matrix); snowDummy.matrix.decompose(snowDummy.position, snowDummy.quaternion, snowDummy.scale); const d = snowData[i];
                    snowDummy.position.y -= d.vy * CONFIG.snow.speed * dt; snowDummy.position.x += Math.sin(et * 0.5 + i) * 2.5 * dt; snowDummy.position.z += Math.cos(et * 0.3 + i) * 1.5 * dt;
                    snowDummy.rotation.x += d.rx * dt; snowDummy.rotation.y += d.ry * dt; snowDummy.rotation.z += d.rz * dt;
                    if (snowDummy.position.y < -25) { snowDummy.position.y = 40; snowDummy.position.x = (Math.random() - 0.5) * CONFIG.snow.range; snowDummy.position.z = (Math.random() - 0.5) * CONFIG.snow.range; }
                    snowDummy.updateMatrix(); snowInstancedMesh.setMatrixAt(i, snowDummy.matrix);
                } snowInstancedMesh.instanceMatrix.needsUpdate = true;
            } else if (snowInstancedMesh) snowInstancedMesh.visible = false;

            // Updated Rotation Logic
            if(manualRotateState.x!==0||manualRotateState.y!==0){const s=CONFIG.interaction.rotationSpeed*2.0;STATE.rotation.x+=manualRotateState.x*s*dt;STATE.rotation.y+=manualRotateState.y*s*dt;}
            else if (STATE.mode === 'SCATTER' && STATE.hand.detected) { const th = 0.3, s = CONFIG.interaction.rotationSpeed; if (STATE.hand.x > th) STATE.rotation.y -= s * dt * (STATE.hand.x - th); else if (STATE.hand.x < -th) STATE.rotation.y -= s * dt * (STATE.hand.x + th); if (STATE.hand.y < -th) STATE.rotation.x += s * dt * (-STATE.hand.y - th); else if (STATE.hand.y > th) STATE.rotation.x -= s * dt * (STATE.hand.y - th); }
            else { if (STATE.mode === 'TREE') { STATE.rotation.y += 0.3 * dt; STATE.rotation.x += (0 - STATE.rotation.x) * 2.0 * dt; } else STATE.rotation.y += 0.1 * dt; }

            mainGroup.rotation.y = STATE.rotation.y; mainGroup.rotation.x = STATE.rotation.x;
            particleSystem.forEach(p => p.update(dt, STATE.mode, STATE.focusTarget));
            composer.render();
        }
        init();
    </script>
</body>

</html>
